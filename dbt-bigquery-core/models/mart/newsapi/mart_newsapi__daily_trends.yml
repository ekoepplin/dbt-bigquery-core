version: 2

models:
  - name: mart_newsapi__daily_trends
    description: "Daily trends of article volume by language"
    config:
      access: public
      contract:
        enforced: true
      materialized: table
      tags: ['mart', 'newsapi', 'reporting', 'time-series']
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - article_date
            - language_code
      # Testing total article count
      - dbt_expectations.expect_table_aggregation_to_equal_other_table:
          expression: SUM(article_count)
          compare_model: ref('int_newsapi__articles_combined')
          compare_expression: COUNT(*)
          compare_row_condition: published_at IS NOT NULL
          tolerance_percent: 0.0001
          config:
            alias: total_daily_articles_match_upstream_count
      # Testing article count by language
      - dbt_expectations.expect_table_aggregation_to_equal_other_table:
          expression: SUM(article_count)
          group_by: [language_code]
          compare_model: ref('int_newsapi__articles_combined')
          compare_expression: COUNT(*)
          compare_group_by: [language_code]
          compare_row_condition: published_at IS NOT NULL
          tolerance_percent: 0.0001
          config:
            alias: daily_articles_by_language_match_upstream
      # Testing article count by date
      - dbt_expectations.expect_table_aggregation_to_equal_other_table:
          expression: SUM(article_count)
          group_by: [article_date]
          compare_model: ref('int_newsapi__articles_combined')
          compare_expression: COUNT(*)
          compare_group_by: [EXTRACT(DATE FROM published_at)]
          compare_row_condition: published_at IS NOT NULL
          tolerance_percent: 0.0001
          config:
            alias: daily_articles_by_date_match_upstream
    columns:
      - name: article_date
        description: "Date of article publication"
        tests:
          - not_null
        meta:
          business_term: "Publication Date"
          data_type: "date"
          validation_rules: "Cannot be in the future"
          sensitivity: "public"
      - name: language_code
        description: "Language code (en or de)"
        tests:
          - not_null
          - accepted_values:
              values: ['en', 'de']
      - name: article_count
        description: "Number of articles published on this date in this language"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: true
        meta:
          business_term: "Article Volume"
          aggregation_type: "count"
          threshold_alerts:
            min: 10
            max: 1000
      - name: source_count
        description: "Number of distinct sources publishing on this date in this language"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: true
      - name: rolling_7day_avg_articles
        description: "7-day rolling average of article count"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: true
      - name: rolling_7day_avg_sources
        description: "7-day rolling average of source count"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: true
      - name: prev_day_article_count
        description: "Previous day's article count"
      - name: day_over_day_change
        description: "Day-over-day percentage change in article count" 